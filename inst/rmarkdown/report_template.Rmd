---
params:
  dataset: NULL 
  target: NULL
  regroup: TRUE
  config: report_options
title: "Exploratory Data Analysis report"
author: "John Doe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center',
	results = "asis", dpi = 150)
options(knitr.kable.NA = '')

library(dplyr)
library(knitr)
library(kableExtra)
#library(formattable)
library(datascan)
library(cowplot)

data <- if (!is.null(params$dataset)) {params$dataset} else {dplyr::starwars}
nr <- nrow(data)
nc <- ncol(data)
ncnum <- select_if(data, is.numeric) %>% ncol()
nccat <- select_if(data, ~is.factor(.x) | is.character(.x)) %>% ncol()
#To avoid width options equal 0 
nonzero <- function(x) {
  if (x == 0) {
    x <- 1
  }
  return(x)
}
target <- params$target
regroup <- params$regroup
```

## Dataset

```{r general}
scd <- scan_data(data)
scc <- scan_columns(data)
```

### General status

```{r tab_scd}
scd %>% 
  kable(align = c("l", "r")) %>% 
  kable_styling(full_width = F, bootstrap_options = "condensed") %>% 
  add_indent(3:(nrow(scd) - 2)) %>%
  column_spec(1, bold = T)
```

### Columns status

```{r tab_scc}
scc %>% 
  select(-contains("p_")) %>% 
  mutate(
    Unique = .apply_colorbar(Unique, nr),
    NAs = .apply_colorbar(n_na, nr),
    Zeros = .apply_colorbar(n_0, nr),
    'Inf' = .apply_colorbar(n_Inf, nr)
  ) %>%
  select(-contains("n_")) %>%
  kable("html", escape = F, align = c("l", "l", rep("r",4))) %>% 
  kable_styling(full_width = F, bootstrap_options = "condensed") %>%
  column_spec(1, bold = T) %>% 
  column_spec(3:6, width = "70px")
```

## Variation

### Numerical columns

```{r nonum}
if (ncnum == 0) {
  cat("There was no numerical columns in the dataset")
}
```

```{r ifnumtable}
if (ncnum > 0) {
  cat("#### Summary table", fill = TRUE)
  scan_numerics(data) %>%
  kable("html", escape = F, align = c("l", rep("r", 9)), digits = 2) %>% 
  kable_styling(full_width = F, bootstrap_options = "condensed")
}
```

```{r ifnumplot1, fig.width = 5, out.width = '50%', fig.asp = 0.8}
if (ncnum == 1) {
  cat("#### Graphics", fill = TRUE)
  cat("", fill = TRUE)
  plotnum <- vis_numerics(data)
  plotnum[[1]]
}
```


```{r ifnumplot2+, fig.width = 10, out.width = '100%',fig.asp = 0.8*nonzero(ceiling(ncnum/4))}
if (ncnum > 1) {
  cat("#### Graphics", fill = TRUE)
  cat("", fill = TRUE)
  plotnum <- vis_numerics(data)
  plot_grid(plotlist = plotnum, align = "hv", ncol = 2)
}
```


### Categorical columns

```{r nocat}
if (nccat == 0) {
  cat("There was no categorical columns in the dataset")
}
```

---
#```{r ifcattable}
# if (nccat > 0) {
#   cat("__Summary table__", fill = TRUE)
#   scan_groups(data) %>%
#     select(-p) %>%
#     mutate(
#       N = .apply_colorbar(n, nr)
#     )  %>%
#     select(-n) %>%
#     kable("html", escape = F, align = c("l", "l", rep("r", 2))) %>%
#     kable_styling(full_width = F, bootstrap_options = "condensed") %>%
#     column_spec(1, bold = T) %>% 
#     column_spec(3, width = "50px")
# }
#```
---


```{r ifcatplot1, fig.width = 5, out.width = '50%', fig.asp = 0.8}
if (nccat == 1) {
  plotcat <- vis_groups(data)
  plotcat[[1]]
}
```

```{r ifcatplot2+, fig.width = 10, out.width = '100%', fig.asp = 0.8*nonzero(ceiling(nccat/4))}
if (nccat > 1) {
  plotcat <- vis_groups(data)
  plot_grid(plotlist = plotcat, align = "hv", ncol = 2)
}
```

## Covariation

### Global covariations

#### Correlations

```{r num01}
if (ncnum < 2) {
  cat("There was less than 2 numerical columns in the dataset")
}
```


```{r corr, out.width = '70%'}
if (ncnum >= 2) {
  vis_corr(data)
}
```

#### Bias corrected Cramer's V

```{r cat01}
if (nccat < 2) {
  cat("There was less than 2 categorical columns in the dataset")
}
```

```{r cramer, out.width = '70%'}
if (nccat >= 2) {
  vis_cramerv(data)
}
```

#### Linear R coefficient between numerical and categorical columns__

```{r num0cat0}
if (nccat == 0 | ncnum == 0) {
  cat("There was no numerical or no categorical columns in the dataset")
}
```

```{r rlin, out.width = '70%'}
if (nccat > 0 & ncnum > 0) {
  vis_r(data)
}
```

### Specific covariations

#### Numerical ~ Numerical

```{r num01bis}
if (ncnum < 2) {
  cat("There was less than 2 numerical columns in the dataset")
}
```

```{r num-num1, fig.width = 5, out.width = '50%', fig.asp = 0.8}
if (ncnum == 2) {
  plotnumnum <- vis_nncovar(data)
  plotnumnum[[1]]
}
```


```{r num-num2+, fig.width = 10, out.width = '100%', fig.asp = 0.8*nonzero(ceiling(ncnum*(ncnum - 1)/8))}
if (ncnum > 2) {
  plotnumnum <- vis_nncovar(data)
  plot_grid(plotlist = plotnumnum, align = "hv", ncol = 2)
}
```

#### Numerical ~ Categorical

```{r num0cat0bis}
if (nccat == 0 & ncnum == 0) {
  cat("There was no numerical or no categorical columns in the dataset")
}
```

```{r num-cat1, fig.width = 5, out.width = '50%', fig.asp = 0.8}
if (nccat == 1 & ncnum == 1) {
  plotnumcat <- vis_ngcovar(data, .regroup = regroup)
  plotnumcat[[1]]
}
```


```{r num-cat2+, fig.width = 10, out.width = '100%', fig.asp = 0.8*nonzero(ceiling(ncnum*nccat/8))}
if (nccat != 0 & ncnum != 0 & nccat + ncnum > 2) {
  plotnumcat <- vis_ngcovar(data, .regroup = regroup)
  plot_grid(plotlist = plotnumcat, align = "hv", ncol = 2)
}
```

#### Categoritcal ~ Categorical


```{r cat01bis}
if (nccat < 2) {
  cat("There was less than 2 categorical columns in the dataset")
}
```

```{r cat-cat1, fig.width = 5, out.width = '50%', fig.asp = 0.8}
if (nccat == 2) {
  plotcatcat <- vis_ggcovar(data, .regroup = regroup)
  plotcatcat[[1]]
}
```


```{r cat-cat2+, fig.width = 10, out.width = '100%', fig.asp = 0.8*nonzero(ceiling(nccat*(nccat - 1)/8))}
if (nccat > 2) {
  plotcatcat <- vis_ggcovar(data, .regroup = regroup)
  plot_grid(plotlist = plotcatcat, align = "hv", ncol = 2)
}
```
